<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üîç FlexSearch Demo - N√¢ng c·∫•p</title>

  <!-- ================== CSS ================== -->
  <style>
    /* ===== B·ªë c·ª•c & chung ===== */
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #fafafa;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
      color: #333;
      line-height: 1.5;
    }

    h1, h2 {
      color: #1e88e5;
      text-align: center;
    }

    /* ===== √î t√¨m ki·∫øm ===== */
    .search-area {
      margin-bottom: 1.5rem;
      text-align: center;
    }

    input[type="search"], 
    input[type="text"], 
    input[type="number"], 
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-top: 6px;
      font-size: 1rem;
    }

    /* ===== N√∫t ===== */
    button {
      padding: 6px 10px;
      border: none;
      border-radius: 6px;
      background-color: #1e88e5;
      color: white;
      cursor: pointer;
      margin-right: 6px;
    }

    button:hover {
      background-color: #1565c0;
    }

    /* ===== K·∫øt qu·∫£ t√¨m ki·∫øm ===== */
    .result {
      background: #fff;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 10px 15px;
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .result .title {
      font-weight: bold;
      color: #1565c0;
    }

    .result small {
      color: #888;
    }

    mark {
      background: yellow;
      font-weight: bold;
    }

    /* ===== Form th√™m t√†i li·ªáu ===== */
    .add-form {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    hr {
      margin: 2rem 0;
      border: 0;
      border-top: 1px solid #ddd;
    }
  </style>
</head>

<body>
  <h1>üîç T√¨m ki·∫øm t√†i li·ªáu (FlexSearch)</h1>
  <p style="text-align:center;">Nh·∫≠p t·ª´ kh√≥a ƒë·ªÉ t√¨m trong t·∫≠p d·ªØ li·ªáu. H·ªó tr·ª£ CRUD (Th√™m / S·ª≠a / X√≥a).</p>

  <!-- √î t√¨m ki·∫øm -->
  <div class="search-area">
    <input id="q" type="search" placeholder="Nh·∫≠p t·ª´ kh√≥a..." oninput="searchDocs()" />
    <div id="stats"></div>
  </div>

  <!-- K·∫øt qu·∫£ t√¨m ki·∫øm -->
  <div id="results"></div>

  <hr>

  <!-- Form th√™m t√†i li·ªáu -->
  <h2>‚ûï Th√™m t√†i li·ªáu m·ªõi</h2>
  <div class="add-form">
    <input id="id" type="number" placeholder="ID" />
    <input id="title" type="text" placeholder="Ti√™u ƒë·ªÅ" />
    <textarea id="content" placeholder="N·ªôi dung"></textarea>
    <button onclick="addDoc()">Th√™m</button>
  </div>

  <!-- ================== JAVASCRIPT ================== -->
  <script>
    // ==============================
    // üöÄ H√ÄM T√åM KI·∫æM
    // ==============================
    async function searchDocs() {
      const q = document.getElementById("q").value.trim();
      const resultsDiv = document.getElementById("results");
      const statsDiv = document.getElementById("stats");

      if (!q) {
        resultsDiv.innerHTML = "";
        statsDiv.innerHTML = "";
        return;
      }

      try {
        const res = await fetch(\`/search?q=\${encodeURIComponent(q)}\`);
        const data = await res.json();

        statsDiv.innerHTML = \`<p><b>\${data.total}</b> k·∫øt qu·∫£ cho "<i>\${q}</i>"</p>\`;

        resultsDiv.innerHTML = data.results.map(doc => \`
          <div class="result">
            <div class="title">\${highlight(doc.title, q)}</div>
            <small>ID: \${doc.id}</small>
            <p>\${highlight(doc.content.slice(0, 200), q)}...</p>
            <button onclick="editDoc(\${doc.id})">‚úèÔ∏è S·ª≠a</button>
            <button onclick="deleteDoc(\${doc.id})">üóëÔ∏è X√≥a</button>
          </div>
        \`).join("");
      } catch (err) {
        console.error("L·ªói khi t√¨m ki·∫øm:", err);
      }
    }

    // ==============================
    // üü° HIGHLIGHT T·ª™ KH√ìA
    // ==============================
    function highlight(text, query) {
      if (!query) return text;
      const regex = new RegExp(\`(\${escapeRegex(query)})\`, "gi");
      return text.replace(regex, "<mark>$1</mark>");
    }

    function escapeRegex(str) {
      return str.replace(/[.*+?^${}()|[\\]\\\\]/g, "\\\\$&");
    }

    // ==============================
    // ‚ûï TH√äM T√ÄI LI·ªÜU M·ªöI
    // ==============================
    async function addDoc() {
      const id = document.getElementById("id").value;
      const title = document.getElementById("title").value;
      const content = document.getElementById("content").value;

      if (!id || !title || !content) {
        alert("Vui l√≤ng nh·∫≠p ƒë·ªß ID, ti√™u ƒë·ªÅ v√† n·ªôi dung!");
        return;
      }

      const res = await fetch("/api/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, title, content })
      });
      const data = await res.json();

      alert(data.message || data.error);
      clearForm();
      searchDocs();
    }

    // ==============================
    // ‚úèÔ∏è S·ª¨A T√ÄI LI·ªÜU
    // ==============================
    async function editDoc(id) {
      const newTitle = prompt("Nh·∫≠p ti√™u ƒë·ªÅ m·ªõi:");
      const newContent = prompt("Nh·∫≠p n·ªôi dung m·ªõi:");
      if (!newTitle || !newContent) return;

      const res = await fetch(\`/api/update/\${id}\`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title: newTitle, content: newContent })
      });
      const data = await res.json();

      alert(data.message || data.error);
      searchDocs();
    }

    // ==============================
    // üóëÔ∏è X√ìA T√ÄI LI·ªÜU
    // ==============================
    async function deleteDoc(id) {
      if (!confirm("X√≥a t√†i li·ªáu n√†y?")) return;
      const res = await fetch(\`/api/remove/\${id}\`, { method: "DELETE" });
      const data = await res.json();
      alert(data.message || data.error);
      searchDocs();
    }

    // ==============================
    // üßπ D·ªåN FORM
    // ==============================
    function clearForm() {
      document.getElementById("id").value = "";
      document.getElementById("title").value = "";
      document.getElementById("content").value = "";
    }
  </script>
</body>
</html>
