<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üîç FlexSearch Demo - G·ª£i √Ω t√¨m ki·∫øm</title>

  <!-- ================== CSS ================== -->
  <style>
    /* ===== B·ªë c·ª•c & chung ===== */
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: #fafafa;
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
      color: #333;
      line-height: 1.5;
    }

    h1, h2 {
      color: #1e88e5;
      text-align: center;
    }
    
    /* --- B·ªê C·ª§C TAB M·ªöI --- */
    .tab-nav {
      border-bottom: 2px solid #ddd;
      margin-bottom: 20px;
    }

    .tab-nav button {
      background-color: inherit;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 14px 16px;
      transition: 0.3s;
      color: #555;
      font-size: 1rem;
      margin-top: 0;
      border-radius: 6px 6px 0 0;
    }

    .tab-nav button:hover {
      background-color: #f1f1f1;
    }

    .tab-nav button.active {
      background-color: #1e88e5;
      color: white;
    }

    .tab-content {
      display: none;
      padding: 6px 12px;
    }
    /* --- K·∫æT TH√öC B·ªê C·ª§C TAB --- */

    .search-container {
        position: relative;
    }

    #q {
        font-size: 1.1rem;
        padding: 12px;
        width: 100%;
        box-sizing: border-box;
    }

    #results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        z-index: 1000;
        max-height: 400px;
        overflow-y: auto;
    }

    .result-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
    }
    .result-item:last-child {
        border-bottom: none;
    }

    .result-item:hover {
        background-color: #f5f5f5;
    }
    
    .result-item .title {
        font-weight: bold;
        color: #1565c0;
    }
    
    .result-item .content-preview {
        font-size: 0.9em;
        color: #555;
        margin-top: 4px;
    }

    input[type="text"], 
    textarea {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      margin-top: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      background-color: #1e88e5;
      color: white;
      cursor: pointer;
      margin-top: 10px;
      font-size: 1rem;
    }

    button:hover {
      background-color: #1565c0;
    }

    mark {
      background: yellow;
      font-weight: bold;
      border-radius: 3px;
      padding: 0 2px;
    }

    .add-form {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    #main-content {
        margin-top: 2rem;
        padding: 20px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        display: none;
    }
  </style>
</head>

<body>
  <h1>üîç T√¨m ki·∫øm t√†i li·ªáu (FlexSearch)</h1>
  <p style="text-align:center;">Chuy·ªÉn tab ƒë·ªÉ th√™m t√†i li·ªáu m·ªõi ho·∫∑c t√¨m ki·∫øm.</p>

  <!-- Thanh ƒëi·ªÅu h∆∞·ªõng Tab -->
  <div class="tab-nav">
    <button id="defaultOpen" class="tab-link active" onclick="openTab(event, 'Search')">üîç T√¨m ki·∫øm</button>
    <button class="tab-link" onclick="openTab(event, 'AddNew')">‚ûï Th√™m m·ªõi</button>
  </div>

  <!-- N·ªôi dung Tab T√¨m ki·∫øm -->
  <div id="Search" class="tab-content">
    <div class="search-container">
      <input id="q" type="search" placeholder="Nh·∫≠p t·ª´ kh√≥a..." oninput="searchDocs()" autocomplete="off" />
      <div id="results"></div>
    </div>
    <div id="main-content"></div>
  </div>

  <!-- N·ªôi dung Tab Th√™m m·ªõi -->
  <div id="AddNew" class="tab-content">
    <h2>‚ûï Th√™m t√†i li·ªáu m·ªõi</h2>
    <div class="add-form">
      <input id="title" type="text" placeholder="Ti√™u ƒë·ªÅ" />
      <textarea id="content" placeholder="N·ªôi dung"></textarea>
      <button onclick="addDoc()">Th√™m</button>
    </div>
  </div>

  <!-- ================== JAVASCRIPT ================== -->
  <script>
    const API_URL = "http://localhost:3000";

    // ==============================
    // ‚ú® H√ÄM M·ªöI: ƒêI·ªÄU KHI·ªÇN TAB
    // ==============================
    function openTab(evt, tabName) {
      const tabcontent = document.getElementsByClassName("tab-content");
      for (let i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      const tablinks = document.getElementsByClassName("tab-link");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(tabName).style.display = "block";
      evt.currentTarget.className += " active";
    }
    // M·ªü tab m·∫∑c ƒë·ªãnh khi t·∫£i trang
    document.getElementById("defaultOpen").click();

    // ==============================
    // üöÄ H√ÄM T√åM KI·∫æM
    // ==============================
    async function searchDocs() {
      const q = document.getElementById("q").value.trim();
      const resultsDiv = document.getElementById("results");
      
      if (!q) {
        resultsDiv.innerHTML = "";
        return;
      }

      try {
        const res = await fetch(`${API_URL}/search?q=${encodeURIComponent(q)}`);
        if (!res.ok) throw new Error(`L·ªói HTTP: ${res.status}`);
        const data = await res.json();

        if (data.results.length === 0) {
            resultsDiv.innerHTML = '<div class="result-item"><span style="color: #888;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£.</span></div>';
            return;
        }

        resultsDiv.innerHTML = data.results.map(doc => `
          <div class="result-item" onclick="selectDoc(${doc.id})">
            <div class="title">${highlight(doc.title, q)}</div>
            <div class="content-preview">${highlight(doc.content.slice(0, 100), q)}...</div>
          </div>
        `).join("");

      } catch (err) {
        console.error("L·ªói khi t√¨m ki·∫øm:", err);
        resultsDiv.innerHTML = '<div class="result-item"><span style="color: red;">L·ªói k·∫øt n·ªëi server.</span></div>';
      }
    }
    
    // ==============================
    // ‚ú® CH·ªåN V√Ä HI·ªÇN TH·ªä CHI TI·∫æT
    // ==============================
    async function selectDoc(id) {
        try {
            const res = await fetch(`${API_URL}/api/doc/${id}`);
            if (!res.ok) throw new Error(`Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu t√†i li·ªáu.`);
            const doc = await res.json();
            
            const mainContentDiv = document.getElementById("main-content");
            
            mainContentDiv.innerHTML = `
                <h2>${doc.title}</h2>
                <p>${doc.content.replace(/\n/g, '<br>')}</p>
                <small>ID: ${doc.id}</small>
                <hr>
                <button onclick="editDoc(${doc.id})">‚úèÔ∏è S·ª≠a</button>
                <button onclick="deleteDoc(${doc.id})">üóëÔ∏è X√≥a</button>
            `;
            mainContentDiv.style.display = 'block';
            
            document.getElementById("results").innerHTML = "";
            document.getElementById("q").value = doc.title;

        } catch(err) {
            console.error("L·ªói khi ch·ªçn t√†i li·ªáu:", err);
            alert("Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt t√†i li·ªáu.");
        }
    }

    // ==============================
    // üü° HIGHLIGHT T·ª™ KH√ìA
    // ==============================
    function highlight(text, query) {
      if (!query || !text) return text || '';
      const regex = new RegExp(`(${escapeRegex(query)})`, "gi");
      return text.replace(regex, "<mark>$1</mark>");
    }

    function escapeRegex(str) {
      if(!str) return '';
      return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    // ==============================
    // ‚ûï TH√äM T√ÄI LI·ªÜU M·ªöI
    // ==============================
    async function addDoc() {
      const title = document.getElementById("title").value;
      const content = document.getElementById("content").value;

      if (!title || !content) {
        alert("Vui l√≤ng nh·∫≠p ƒë·ªß ti√™u ƒë·ªÅ v√† n·ªôi dung!");
        return;
      }

      try {
          const res = await fetch(`${API_URL}/api/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, content })
          });
          const data = await res.json();

          alert(data.message || data.error);
          if (res.ok) {
            clearForm();
          }
      } catch(err) {
          console.error("L·ªói khi th√™m:", err);
          alert("ƒê√£ x·∫£y ra l·ªói khi th√™m t√†i li·ªáu.");
      }
    }

    // ==============================
    // ‚úèÔ∏è S·ª¨A T√ÄI LI·ªÜU
    // ==============================
    async function editDoc(id) {
      const currentDoc = await (await fetch(`${API_URL}/api/doc/${id}`)).json();
      
      const newTitle = prompt("Nh·∫≠p ti√™u ƒë·ªÅ m·ªõi:", currentDoc.title);
      if (newTitle === null) return;
      const newContent = prompt("Nh·∫≠p n·ªôi dung m·ªõi:", currentDoc.content);
      if (newContent === null) return;

      try {
          const res = await fetch(`${API_URL}/api/update/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: newTitle, content: newContent })
          });
          const data = await res.json();
          alert(data.message || data.error);
          if(res.ok) selectDoc(id);
      } catch(err) {
          console.error("L·ªói khi s·ª≠a:", err);
          alert("ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t t√†i li·ªáu.");
      }
    }

    // ==============================
    // üóëÔ∏è X√ìA T√ÄI LI·ªÜU
    // ==============================
    async function deleteDoc(id) {
      if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i li·ªáu c√≥ ID l√† ${id}?`)) return;
      try {
          const res = await fetch(`${API_URL}/api/remove/${id}`, { method: "DELETE" });
          const data = await res.json();
          alert(data.message || data.error);
          if(res.ok) {
            document.getElementById("main-content").style.display = 'none';
            document.getElementById("q").value = '';
          }
      } catch(err) {
          console.error("L·ªói khi x√≥a:", err);
          alert("ƒê√£ x·∫£y ra l·ªói khi x√≥a t√†i li·ªáu.");
      }
    }

    // ==============================
    // üßπ D·ªåN FORM
    // ==============================
    function clearForm() {
      document.getElementById("title").value = "";
      document.getElementById("content").value = "";
    }
    
    // ƒê√≥ng danh s√°ch g·ª£i √Ω khi b·∫•m ra ngo√†i
    document.addEventListener('click', function(event) {
        const searchContainer = document.querySelector('.search-container');
        if (searchContainer && !searchContainer.contains(event.target)) {
            document.getElementById('results').innerHTML = '';
        }
    });
  </script>
</body>
</html>